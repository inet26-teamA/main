<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
  <title>住所検索付きのLeaflet Map</title>
  <!-- LeafletのCSSを読み込み -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <!-- アプリのスタイルシート -->
  <link rel="stylesheet" href="/static/css/index_styles.css">
  <link href="https://use.fontawesome.com/releases/v5.6.1/css/all.css" rel="stylesheet">
</head>

<body>
  <h1>地域観光ナビ</h1>

  <!-- 天気・観光地登録へのボタン・検索・カレンダー -->
  <div class="top-container">
    <!-- 天気 -->
    <div class="top-left-container">
      <p>現在地の3時間ごとの天気</p>
      {% for message in gemini_message %}
      <!-- <p class="weather-gemini-message">{{ message }}</p> -->
      {% endfor %}
      {% for image in images %}
      <img src="../static/img/{{ image }}.png" alt="{{ image }}.png" class="weather-image">
      {% endfor %}
    </div>

    <!-- 住所入力フィールドと検索ボタン -->
    <div class="search-container">
      <input type="text" id="address-input" placeholder="住所を入力">
      <button id="search-btn">検索</button>
    </div>

    <!-- カレンダーボタン -->
    <div class="top-right-container">
      <form action="{{ url_for('event_reg') }}" method="get">
        <button id="add-event">イベントの登録</button>
      </form>

      <form action="{{ url_for('past_events') }}" method="get">
        <button id="past-events">過去に登録されたイベント</button>
      </form>
    </div>
  </div>

  <!-- 地図を表示する要素 -->
  <div id="map"></div>

  <!-- LeafletのJSを読み込み -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- アプリのJavaScriptファイル -->
  <script src="/static/js/script.js"></script>
  <script>
    // search-btnクリックイベント
    document.getElementById('search-btn').addEventListener('click', async function () {
      const address = document.getElementById('address-input').value;
      if (address) {
        try {
          // Nominatim APIで住所の緯度経度を取得
          const geoResponse = await fetch(`https://nominatim.openstreetmap.org/search?format=json&countrycodes=JP&limit=1&q=${encodeURIComponent(address)}`);
          const geoData = await geoResponse.json();
          if (geoData && geoData.length > 0) {
            const lat = parseFloat(geoData[0].lat);
            const lon = parseFloat(geoData[0].lon);

            // OpenWeather APIで天気情報を取得 (APIキーが必要です)
            const apiKey = '4d11781b6190ab2bd390e6df45db4356';
            const weatherResponse = await fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=${apiKey}&units=metric&lang=en`);
            const weatherData = await weatherResponse.json();

            // 取得した天気情報をDOMに動的に追加
            const imageContainer = document.querySelector('.top-left-container');
            imageContainer.innerHTML = `<p>${address}の3時間ごとの天気</p>`; // 初期設定

            // 3時間ごとの天気データを6つ表示（アイコンのみ）
            for (let i = 0; i < 6; i++) {
              const weather = weatherData.list[i];
              const imgElement = document.createElement('img');
              imgElement.src = `../static/img/${weather.weather[0].description}.png`;
              imgElement.alt = `${weather.weather[0].icon}.png`;
              imgElement.className = 'weather-image';
              imageContainer.appendChild(imgElement);
            }

          } else {
            alert('住所が見つかりませんでした。');
          }
        } catch (error) {
          console.error('Error:', error);
          alert('検索中にエラーが発生しました。');
        }
      } else {
        alert('住所を入力してください。');
      }
    });
  </script>

</body>

</html>